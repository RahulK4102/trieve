---
import {
  ChunkCollectionDTO,
  UserDTOWithVotesAndChunks,
  isChunkCollectionPageDTO,
  isUserDTOWithVotesAndChunks,
} from "../../../utils/apiTypes";
import Footer from "../../components/Footer.astro";
import SearchLayout from "../../layouts/SearchLayout.astro";
import { UserChunkDisplay } from "../../components/UserChunkDisplay";
import { useStore } from "@nanostores/solid";
import { currentDataset } from "../../stores/datasetStore";

const apiHost = import.meta.env.PUBLIC_API_HOST as string;
const $dataset = useStore(currentDataset)()?.dataset.id;

let { id } = Astro.params;
id = id?.split("&")[0];
const requestParams = Astro.request.url.split("?")[1];
const params = new URLSearchParams(requestParams);
const page = Number(params.get("page")) || 1;

let user: UserDTOWithVotesAndChunks | null = null;
let title = "User Profile";
let userCollections: ChunkCollectionDTO[] | null = null;
let userCollectionPageCount = 1;

try {
  if (!id) {
    throw new Error("No user id provided");
  }

  const queryPromise = fetch(`${apiHost}/user/${id}/${page}`, {
    method: "GET",
    headers: {
      "AF-Dataset": $dataset ??  "",
      "Content-Type": "application/json",
    },
  });

  const collectionsPromise = fetch(`${apiHost}/user/collections/${id}/1`, {
    method: "GET",
    headers: {
      "AF-Dataset": $dataset ??  "",
    },
  });

  const [queryResult, collectionsResult] = await Promise.all([
    queryPromise,
    collectionsPromise,
  ]);

  if (queryResult.status !== 200) {
    throw new Error("Error fetching user");
  }
  // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment
  const maybeUser = await queryResult.json();
  if (isUserDTOWithVotesAndChunks(maybeUser)) {
    user = maybeUser;
    title = user.username ?? user.email ?? "";
    title += " | Arguflow Search";
  } else {
    throw new Error("Invalid response");
  }

  if (collectionsResult.ok) {
    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment
    const maybeCollections = await collectionsResult.json();
    if (isChunkCollectionPageDTO(maybeCollections)) {
      userCollections = maybeCollections.collections;
      userCollectionPageCount =
        maybeCollections.total_pages == 0 ? 1 : maybeCollections.total_pages;
    }
  }
} catch (error) {
  console.error("Error fetching data", error);
}
---

<SearchLayout title={title}>
  <div class="mx-auto w-full max-w-6xl px-4">
    <UserChunkDisplay
      id={id ?? ""}
      page={page}
      initialUser={user}
      initialUserCollections={userCollections ?? []}
      initialUserCollectionPageCount={userCollectionPageCount}
      client:load
    />
  </div>
  <div class="flex-1"></div>
  <Footer />
</SearchLayout>
